#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Meeting Bot –Ω–∞ VPS

set -e

echo "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Meeting Bot –Ω–∞ VPS..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo bash deploy.sh${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∞ root –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã${NC}"

# –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORK_DIR="/opt/meeting-bot"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
if [ ! -d "${WORK_DIR}" ]; then
    echo -e "${RED}‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${WORK_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ install.sh${NC}"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo -e "${YELLOW}‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞...${NC}"
systemctl stop meeting-bot.service || true

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ${WORK_DIR}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub
echo -e "${YELLOW}üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub...${NC}"
git fetch origin
git reset --hard origin/main

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo -e "${YELLOW}üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
chown -R bot:bot ${WORK_DIR}
chmod +x ${WORK_DIR}/meeting-bot.py

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd
echo -e "${YELLOW}‚öôÔ∏è  –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd...${NC}"
systemctl daemon-reload

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞...${NC}"
systemctl start meeting-bot.service

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo -e "${YELLOW}üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...${NC}"
sleep 3
systemctl status meeting-bot.service --no-pager

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
echo ""
echo -e "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:"
echo -e "   ${YELLOW}systemctl status meeting-bot${NC}"
echo ""
echo -e "–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:"
echo -e "   ${YELLOW}tail -f /var/log/meeting-bot/output.log${NC}"
echo -e "   ${YELLOW}journalctl -u meeting-bot -f${NC}"
echo ""
echo -e "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:"
echo -e "   ${YELLOW}systemctl restart meeting-bot${NC}"
echo ""
echo -e "${GREEN}========================================${NC}"
