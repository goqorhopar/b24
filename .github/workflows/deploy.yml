name: Deploy Meeting Bot to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Meeting Bot..."
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /opt/meeting-bot || exit 1
          
          # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
          echo "‚è∏Ô∏è  –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞..."
          systemctl stop meeting-bot.service 2>/dev/null || true
          pkill -f meeting-bot.py 2>/dev/null || true
          pkill -f python.*meeting-bot 2>/dev/null || true
          sleep 5
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π .env —Ñ–∞–π–ª
          if [ -f .env ]; then
            cp .env .env.backup
            echo "üíæ .env —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
          fi
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git fetch origin
          git reset --hard origin/main
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env –µ—Å–ª–∏ –æ–Ω –±—ã–ª
          if [ -f .env.backup ]; then
            mv .env.backup .env
            echo "‚úÖ .env —Ñ–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi
          
          # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          source venv/bin/activate
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo "üì¶ –û–±–Ω–æ–≤–ª—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
          if [ ! -f .env ] || ! grep -q "TELEGRAM_BOT_TOKEN" .env; then
            echo "‚ö†Ô∏è  –°–æ–∑–¥–∞—é .env —Ñ–∞–π–ª –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤..."
            cat > .env << 'ENV_EOF'
          # Telegram
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          
          # GitHub
          GITHUB_TOKEN=${{ secrets.REPO_TOKEN }}
          GITHUB_REPO=${{ secrets.REPO_NAME }}
          
          # Bot Settings
          BOT_NAME=MeetingBot
          RECORD_DIR=/opt/meeting-bot/recordings
          WHISPER_MODEL=medium
          MEETING_TIMEOUT_MIN=180
          ENV_EOF
            echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∑–∞–ø–∏—Å–µ–π
          mkdir -p recordings
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          echo "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
          chown -R bot:bot /opt/meeting-bot
          chmod +x meeting-bot.py
          chmod 600 .env
          
          # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd
          systemctl daemon-reload
          
          # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
          echo "üöÄ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∑–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ v2.2..."
          systemctl start meeting-bot.service
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
          if pgrep -f meeting-bot.py > /dev/null; then
            echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
          else
            echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–±—É—é –µ—â–µ —Ä–∞–∑..."
            systemctl restart meeting-bot.service
            sleep 10
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞..."
          systemctl status meeting-bot.service --no-pager
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
          journalctl -u meeting-bot.service --no-pager -n 20
          
          echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        else
          echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        fi
